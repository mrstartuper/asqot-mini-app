<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASQOT AI Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px 10px 60px 10px; /* Bottom for nav */
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background 0.3s, color 0.3s;
        }
        .section { display: none; }
        #dashboard-section { display: block; } /* Initial */
        #metrics, #task-list { display: flex; flex-wrap: wrap; justify-content: space-around; }
        .metric-card, .task-card { background: var(--tg-theme-secondary-bg-color); padding: 10px; border-radius: 8px; text-align: center; margin: 5px; width: 45%; }
        #chat { height: 400px; overflow-y: scroll; border: 1px solid var(--tg-theme-section-separator-color); padding: 10px; background: var(--tg-theme-section-bg-color); margin-bottom: 10px; }
        #chat p { margin: 5px 0; padding: 8px; border-radius: 8px; }
        #chat .user { background: var(--tg-theme-accent-text-color); color: white; text-align: right; }
        #chat .ai { background: var(--tg-theme-secondary-bg-color); }
        #chat .system { text-align: center; color: gray; font-style: italic; }
        #input { width: 100%; padding: 10px; box-sizing: border-box; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: 1px solid var(--tg-theme-section-separator-color); }
        button { padding: 10px; background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; margin-top: 5px; }
        #nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; background: var(--tg-theme-bg-color); padding: 10px 0; border-top: 1px solid var(--tg-theme-section-separator-color); }
        .nav-btn { background: none; color: var(--tg-theme-text-color); }
        body { padding-bottom: 70px; } /* Nav space */
    </style>
</head>
<body>
    <h1>ASQOT AI</h1>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
        <h2>Dashboard</h2>
        <div id="metrics"></div>
        <h3>Task List</h3>
        <div id="task-list"></div>
        <h3>Recent Activity</h3>
        <div id="recent-activity"></div>
    </div>

    <!-- Chat Section -->
    <div id="chat-section" class="section">
        <div id="chat"></div>
        <input id="input" type="text" placeholder="Savolingizni kiriting...">
        <button id="voice-btn" onclick="startVoiceRecognition()">üé§ Ovoz orqali kiritish</button>
    </div>

    <!-- Settings Section -->
    <div id="settings-section" class="section">
        <h2>Sozlamalar</h2>
        <p>User Profile: <span id="user-info"></span></p>
        <button onclick="changeSector()">Sektor o‚Äòzgartirish</button>
        <button onclick="toggleAutoSpeak()">Avto-ovoz: <span id="auto-speak-status"></span></button>
        <button onclick="changeLanguage()">Til tanlash</button>
        <button onclick="logout()">Chiqish</button>
    </div>

    <!-- Navigation Bar -->
    <div id="nav-bar">
        <button class="nav-btn" onclick="showSection('dashboard')">üè† Dashboard</button>
        <button class="nav-btn" onclick="showSection('chat')">üí¨ Chat</button>
        <button class="nav-btn" onclick="createTask()">üìù Task Yaratish</button>
        <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Sozlamalar</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Theme
        function applyTheme() {
            document.body.style.background = tg.themeParams.bg_color;
        }
        applyTheme();
        tg.onEvent('themeChanged', applyTheme);

        // MainButton for send in chat
        const mainButton = tg.MainButton;
        mainButton.setText('Yuborish');
        mainButton.onClick(sendMessage);
        mainButton.hide(); // Hide initially, show in chat

        // Sectors and globals
        const sectors = ['Davlat xizmatlari', 'Tibbiyot', 'Ta‚Äôlim', 'Energetika', 'Logistika', 'Qishloq xo‚Äòjaligi', 'Biznes jarayonlari'];
        let selectedSector = localStorage.getItem('selectedSector') || sectors[0];
        let authToken = localStorage.getItem('asqotToken') || null;
        let userRole = localStorage.getItem('userRole') || 'user';
        const chatDiv = document.getElementById('chat');
        const metricsDiv = document.getElementById('metrics');
        const taskListDiv = document.getElementById('task-list');
        const recentActivityDiv = document.getElementById('recent-activity');
        const chatHistory = JSON.parse(localStorage.getItem('asqotChat')) || [];

        // Voice settings
        let autoSpeak = JSON.parse(localStorage.getItem('autoSpeak')) || false;
        document.getElementById('auto-speak-status').textContent = autoSpeak ? 'Yoqilgan' : 'O‚Äòchirilgan';
        let selectedVoiceLang = localStorage.getItem('asqotVoiceLang') || 'uz-UZ';
        const speechSynth = window.speechSynthesis;
        let availableVoices = [];
        let selectedVoice = null;
        if (speechSynth) {
            speechSynth.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function loadVoices() {
            availableVoices = speechSynth.getVoices();
            updateSelectedVoice();
        }

        function updateSelectedVoice() {
            selectedVoice = availableVoices.find(v => v.lang === selectedVoiceLang) || availableVoices[0];
        }

        function getAvailableLanguages() {
            const langs = [...new Set(availableVoices.map(v => v.lang))];
            return langs.length > 0 ? langs : ['en-US', 'ru-RU', 'uz-UZ'];
        }

        // Add to chat
        function addToChat(role, message, explanation = '') {
            const p = document.createElement('p');
            p.classList.add(role);
            p.innerHTML = `<b>${role === 'Siz' ? 'Siz' : 'ASQOT AI'}:</b> ${message}`;
            if (explanation) p.innerHTML += `<br><i>Izoh: ${explanation}</i>`;
            if (role === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Nusxa olish';
                copyBtn.onclick = () => copyToClipboard(message);
                p.appendChild(copyBtn);

                const speakBtn = document.createElement('button');
                speakBtn.textContent = 'Ovoz chiqarish';
                speakBtn.onclick = () => speakText(message);
                p.appendChild(speakBtn);

                if (autoSpeak) speakText(message);
            }
            chatDiv.appendChild(p);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            chatHistory.push({ role, message });
            localStorage.setItem('asqotChat', JSON.stringify(chatHistory));
        }

        // Load chat history
        chatHistory.forEach(({ role, message }) => addToChat(role, message));

        // Initial welcome
        addToChat('system', 'Xush kelibsiz! Sektor: ' + selectedSector);

        // Show section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(section + '-section').style.display = 'block';
            if (section === 'chat') mainButton.show();
            else mainButton.hide();
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('input');
            const query = input.value.trim();
            if (!query) return;

            addToChat('Siz', query);
            input.value = '';

            tg.HapticFeedback.impactOccurred('light');
            mainButton.showProgress(true);

            const fullQuery = `${selectedSector}: ${query}`;
            try {
                const res = await fetch('https://api.asqot.ai/v1/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ query: fullQuery, conversation_id: 'mini_app_conv' })
                });
                const data = await res.json();
                addToChat('ASQOT AI', data.data.response, data.data.explanation);
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                tg.showAlert('Xato: ' + error.message);
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                mainButton.hideProgress();
            }
        }

        // Voice recognition
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) return tg.showAlert('Ovoz tanish qo‚Äòllab-quvvatlanmaydi');
            const recognition = new webkitSpeechRecognition();
            recognition.lang = selectedVoiceLang;
            recognition.onresult = (event) => {
                document.getElementById('input').value = event.results[0][0].transcript;
                tg.HapticFeedback.selectionChanged();
            };
            recognition.onerror = () => tg.showAlert('Ovoz tanishda xato');
            recognition.start();
        }

        // Voice output
        function speakText(text) {
            if (!speechSynth) return;
            speechSynth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = selectedVoiceLang;
            if (selectedVoice) utterance.voice = selectedVoice;
            speechSynth.speak(utterance);
            tg.HapticFeedback.impactOccurred('soft');
        }

        // Copy
        function copyToClipboard(text) {
            tg.writeTextToClipboard(text);
            tg.showAlert('Nusxa olindi!');
            tg.HapticFeedback.impactOccurred('medium');
        }

        // Change sector
        function changeSector() {
            tg.showPopup({
                title: 'Sektor tanlang',
                buttons: sectors.map((s, i) => ({ id: i.toString(), text: s }))
            }, (id) => {
                selectedSector = sectors[parseInt(id)];
                localStorage.setItem('selectedSector', selectedSector);
                addToChat('system', `Sektor: ${selectedSector}`);
                loadDashboard();
            });
        }

        // Toggle auto speak
        function toggleAutoSpeak() {
            autoSpeak = !autoSpeak;
            localStorage.setItem('autoSpeak', autoSpeak);
            document.getElementById('auto-speak-status').textContent = autoSpeak ? 'Yoqilgan' : 'O‚Äòchirilgan';
            addToChat('system', `Avto-ovoz: ${autoSpeak ? 'Yoqilgan' : 'O‚Äòchirilgan'}`);
        }

        // Change language
        function changeLanguage() {
            const langs = getAvailableLanguages();
            tg.showPopup({
                title: 'Til tanlang',
                buttons: langs.map((l, i) => ({ id: i.toString(), text: l }))
            }, (id) => {
                selectedVoiceLang = langs[parseInt(id)];
                localStorage.setItem('asqotVoiceLang', selectedVoiceLang);
                updateSelectedVoice();
                addToChat('system', `Til: ${selectedVoiceLang}`);
            });
        }

        // Create task
        function createTask() {
            tg.showPopup({
                title: 'Yangi Task/Ariza',
                message: 'Tavsif kiriting',
                buttons: [{ id: 'create', text: 'Yaratish' }]
            }, () => {
                const title = prompt('Sarlavha:');
                const desc = prompt('Tavsif:');
                if (title && desc) {
                    fetch('https://api.asqot.ai/v1/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ title, description: desc, type: 'manual', priority: 'medium', sector: selectedSector })
                    }).then(res => res.json())
                    .then(data => {
                        addToChat('system', `Task yaratildi: ID ${data.data.id}`);
                        loadDashboard();
                    }).catch(err => tg.showAlert('Xato: ' + err.message));
                }
            });
        }

        // Load dashboard (metrics, tasks, activity)
        async function loadDashboard() {
            if (!authToken) return loginPopup();

            // Metrics
            metricsDiv.innerHTML = '';
            try {
                const res = await fetch('https://api.asqot.ai/v1/analytics/dashboard', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const kpis = data.data.kpis;
                Object.keys(kpis).forEach(key => {
                    const card = document.createElement('div');
                    card.classList.add('metric-card');
                    card.innerHTML = `<b>${key}:</b> ${kpis[key]}`;
                    metricsDiv.appendChild(card);
                });
            } catch (err) {
                metricsDiv.innerHTML = '<p>Metrics yuklanmadi</p>';
            }

            // Task list
            taskListDiv.innerHTML = '';
            try {
                const res = await fetch('https://api.asqot.ai/v1/tasks?status=pending', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                data.data.items.forEach(task => {
                    const card = document.createElement('div');
                    card.classList.add('task-card');
                    card.innerHTML = `<b>${task.title}</b><br>Status: ${task.status}<br><button onclick="updateTaskStatus('${task.id}', 'completed')">Tamomlash</button>`;
                    taskListDiv.appendChild(card);
                });
            } catch (err) {
                taskListDiv.innerHTML = '<p>Tasklar yuklanmadi</p>';
            }

            // Recent activity (mock or fetch)
            recentActivityDiv.innerHTML = '<p>Oxirgi faoliyat: Task yaratildi (misol)</p>';
        }

        // Update task status
        async function updateTaskStatus(id, status) {
            try {
                const res = await fetch(`https://api.asqot.ai/v1/tasks/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ status })
                });
                await res.json();
                tg.showAlert('Status yangilandi!');
                loadDashboard();
            } catch (err) {
                tg.showAlert('Xato: ' + err.message);
            }
        }

        // Login popup
        function loginPopup() {
            tg.showPopup({
                title: 'Kirish',
                message: 'Email va parol kiriting',
                buttons: [{ id: 'login', text: 'Kirish' }]
            }, () => {
                const email = prompt('Email:');
                const pass = prompt('Parol:');
                fetch('https://api.asqot.ai/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password: pass })
                }).then(res => res.json())
                .then(data => {
                    authToken = data.data.access_token;
                    userRole = data.data.user.role;
                    localStorage.setItem('asqotToken', authToken);
                    localStorage.setItem('userRole', userRole);
                    document.getElementById('user-info').textContent = data.data.user.name + ' (' + userRole + ')';
                    addToChat('system', 'Kirish muvaffaqiyatli!');
                    loadDashboard();
                }).catch(err => tg.showAlert('Kirish xatosi'));
            });
        }

        // Logout
        function logout() {
            authToken = null;
            localStorage.removeItem('asqotToken');
            localStorage.removeItem('userRole');
            tg.showAlert('Chiqildi!');
            showSection('dashboard');
            loadDashboard(); // Will trigger login
        }

        // Initial load
        if (authToken) {
            loadDashboard();
            document.getElementById('user-info').textContent = 'User (' + userRole + ')';
        } else {
            loginPopup();
        }

        tg.enableClosingConfirmation();
    </script>
</body>
</html>
